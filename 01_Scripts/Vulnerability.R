library(tidyverse)

# Load Phase 2 results (if not already in environment)
# Assuming you have: phys_growth, temporal_change, moving_window_results

# Extract adaptive capacity metric from temporal trends
# Option A: Extract temporal slope from moving windows
adaptive_trends <- moving_window_results %>%
  group_by(Plot) %>%
  summarize(
    Temporal_slope = coef(lm(Summer_cor ~ Year))[2]
  )

# Option B: Use change metric directly (simpler)

adaptive_trends <- temporal_change %>%
  select(Plot = Plot_fixed, Temporal_change = Change)

# Now compile again
vulnerability <- phys_growth %>%
  left_join(adaptive_trends, by = "Plot") %>%
  select(
    Plot, Bin, Latitude,
    Slope, Exposure,
    Mean_Vcmax,
    Summer_temp_cor,
    Temporal_change,
    Mean_Jmax, Mean_JV_ratio
  )

# Check
head(vulnerability)
summary(vulnerability)

# Correlation check
cor(vulnerability[, c("Mean_Vcmax", "Summer_temp_cor", "Temporal_change")], 
    use = "complete.obs")




#########standardise metrics:
vulnerability <- vulnerability %>%
  mutate(
    # 1. Structural vulnerability (LOW Vcmax = vulnerable)
    Struct_vuln = 1 - (Mean_Vcmax - min(Mean_Vcmax)) / 
      (max(Mean_Vcmax) - min(Mean_Vcmax)),
    
    # 2. Functional vulnerability (NEGATIVE temp sensitivity = vulnerable)
    Funct_vuln = 1 - (Summer_temp_cor - min(Summer_temp_cor)) / 
      (max(Summer_temp_cor) - min(Summer_temp_cor)),
    
    # 3. Adaptive vulnerability (LOW/NEGATIVE temporal change = vulnerable)
    Adaptive_vuln = 1 - (Temporal_change - min(Temporal_change)) / 
      (max(Temporal_change) - min(Temporal_change))
  )

# Check standardization
summary(vulnerability[, c("Struct_vuln", "Funct_vuln", "Adaptive_vuln")])

# Quick visual check
vulnerability %>%
  select(Plot, Slope, Struct_vuln, Funct_vuln, Adaptive_vuln) %>%
  arrange(desc(Struct_vuln))


######### Create composite vulnerability:
# Equal weighting (simple approach)
vulnerability <- vulnerability %>%
  mutate(
    Vulnerability_index = (Struct_vuln + Funct_vuln + Adaptive_vuln) / 3
  )

# Check distribution
summary(vulnerability$Vulnerability_index)

# See top/bottom sites
vulnerability %>%
  select(Plot, Slope, Exposure, Vulnerability_index, 
         Struct_vuln, Funct_vuln, Adaptive_vuln) %>%
  arrange(desc(Vulnerability_index))

######### Risk categories:
# Define thresholds (tertiles or custom)
vulnerability <- vulnerability %>%
  mutate(
    # Tertile approach
    Risk_class = case_when(
      Vulnerability_index >= quantile(Vulnerability_index, 0.67) ~ "High Risk",
      Vulnerability_index >= quantile(Vulnerability_index, 0.33) ~ "Moderate Risk",
      TRUE ~ "Low Risk"
    ),
    Risk_class = factor(Risk_class, levels = c("Low Risk", "Moderate Risk", "High Risk"))
  )

# Summary by risk class
table(vulnerability$Risk_class)

# By topography
table(vulnerability$Slope, vulnerability$Risk_class)

# Show classification
vulnerability %>%
  select(Plot, Slope, Latitude, Risk_class, Vulnerability_index) %>%
  arrange(desc(Vulnerability_index))

vulnerability %>%
  group_by(Risk_class) %>%
  summarize(
    n = n(),
    Mean_lat = mean(Latitude),
    Mean_vuln = mean(Vulnerability_index)
  )


####### VAlidate:
# Does vulnerability match Phase 1 expectations?
# Steep slopes (C) should be high risk, right?
vulnerability %>%
  group_by(Slope) %>%
  summarize(
    n = n(),
    Mean_vulnerability = mean(Vulnerability_index),
    Mean_Vcmax = mean(Mean_Vcmax),
    Mean_temp_sens = mean(Summer_temp_cor)
  )

# Geographic clustering?
ggplot(vulnerability, aes(Latitude, Vulnerability_index, color = Risk_class)) +
  geom_point(size = 4) +
  geom_text(aes(label = Plot), hjust = -0.2, size = 3) +
  scale_color_manual(values = c("Low Risk" = "green3", 
                                "Moderate Risk" = "orange", 
                                "High Risk" = "red")) +
  labs(x = "Latitude", y = "Vulnerability Index") +
  theme_minimal()


##################### Visualise
library(ggplot2)

# 1. Vulnerability across gradient
p1 <- ggplot(vulnerability, aes(Latitude, Vulnerability_index, 
                                color = Risk_class, shape = Slope)) +
  geom_point(size = 4) +
  scale_color_manual(values = c("Low Risk" = "green3", 
                                "Moderate Risk" = "orange", 
                                "High Risk" = "red")) +
  labs(x = "Latitude (Â°N)", y = "Vulnerability Index",
       title = "Climate Vulnerability Across Latitudinal Gradient") +
  theme_bw()

# 2. Component contributions
p2 <- vulnerability %>%
  select(Plot, Slope, Risk_class, Struct_vuln, Funct_vuln, Adaptive_vuln) %>%
  pivot_longer(cols = c(Struct_vuln, Funct_vuln, Adaptive_vuln),
               names_to = "Component", values_to = "Score") %>%
  mutate(Component = factor(Component, 
                            levels = c("Struct_vuln", "Funct_vuln", "Adaptive_vuln"),
                            labels = c("Structural", "Functional", "Adaptive"))) %>%
  ggplot(aes(x = reorder(Plot, -Score), y = Score, fill = Component)) +
  geom_col(position = "dodge") +
  facet_wrap(~Risk_class, scales = "free_x") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "Plot", y = "Vulnerability Score", 
       title = "Vulnerability Components by Risk Class")

print(p1)
print(p2)
